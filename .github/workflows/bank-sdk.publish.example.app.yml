name: Publish GiniBankSDKExample to App Center
on:
  push:
    branches:
      - PIA-1851_distr_appcenter

jobs:
  #check:
  #  uses: gini/gini-mobile-ios/.github/workflows/bank-sdk.check.yml@PIA-1851_distr_appcenter
  #  secrets:
  #    GINI_MOBILE_TEST_CLIENT_SECRET: ${{ secrets.GINI_MOBILE_TEST_CLIENT_SECRET }}

  upload-version:
    #needs: check
    runs-on: macOS-11    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '13.0'
        
      - name: Install gpg
        run: brew install gnupg
  
      - name: Setup provisioning profile
        env:
          IOS_KEYS: ${{ secrets.IOS_CERTS_SECRET }}
        run: |
          gpg --quiet --batch --yes --decrypt --passphrase="${{ secrets.IOS_CERTS_SECRET }}" --output ./.github/secrets/Bank_SDK_Example_Distribution.mobileprovision.mobileprovision ./.github/secrets/Bank_SDK_Example_Distribution.mobileprovision.gpg
          gpg --quiet --batch --yes --decrypt --passphrase="${{ secrets.IOS_CERTS_SECRET }}" --output ./.github/secrets/ios_distribution_universal.p12 ./.github/secrets/ios_distribution_universal.p12.gpg
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp ./.github/secrets/Bank_SDK_Example_Distribution.mobileprovision.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/Bank_SDK_Example_Distribution.mobileprovision.mobileprovision
          security create-keychain -p "" build.keychain
          security import ./.github/secrets/ios_distribution_universal.p12 -t agg -k ~/Library/Keychains/build.keychain -P "" -A
          security list-keychains -s ~/Library/Keychains/build.keychain
          security default-keychain -s ~/Library/Keychains/build.keychain
          security unlock-keychain -p "" ~/Library/Keychains/build.keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "" ~/Library/Keychains/build.keychain

      - name: Archiving project
        run: |
            cd BankSDK
            xcodebuild \
            -project GiniBankSDKExample/GiniBankSDKExample.xcodeproj \
            -scheme "GinBankSDKExampleBank" \
            -archivePath $PWD/../GinBankSDKExampleBank.xcarchive \
            -configuration Release
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO \
            CLIENT_ID="gini-mobile-test" \
            CLIENT_SECRET="${{ secrets.GINI_MOBILE_TEST_CLIENT_SECRET }}"
    
      - name: Exporting .ipa
        run: >
            xcodebuild -archivePath $PWD/GinBankSDKExampleBank.xcarchive \
            -exportArchive \
            -exportPath $PWD/ \
            -allowProvisioningUpdates \
            -destination "generic/platform=iOS"
            CODE_SIGNING_REQUIRED=YES \
            ONLY_ACTIVE_ARCH=NO \
            -exportOptionsPlist  $PWD/ExportOptions.plist
  
      - name: Check file existence
        uses: andstor/file-existence-action@v1
        with:
          files: "*.ipa"
      
      - name: Distribute to AppCenter
        uses: devussy/AppCenter-Distribute-Github-Action@v1.0.2
        with:
          app: Gini-Team-Organization/Gini-Bank-SDK-Example
          token: ${{ secrets.GINI_APPCENTER_API_TOKEN }}
          group: Production
          file: $PWD/GinBankSDKExampleBank.ipa
          silent: false
          