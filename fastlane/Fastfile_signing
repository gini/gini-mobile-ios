
default_platform(:ios)

platform :ios do
  desc <<~DOC
    Download provisioning profiles from the remote repository for GitHub Actions.

    Parameters:
      APP_IDENTIFIER      - The bundle identifier of the app (from ENV).
      DISTRIBUTION_TYPE   - The type of provisioning profile (appstore, adhoc, development, enterprise) (from ENV).
      GIT_URL             - The git repository URL where provisioning profiles are stored (from ENV).
      KEYCHAIN_PASSWORD   - The password for the temporary keychain (from ENV).

    Behavior:
      - Sets up and unlocks a temporary keychain for code signing.
      - Downloads and installs provisioning profiles using match in readonly mode.
      - Does not modify the profiles repository (readonly: true).
  DOC
  lane :download_profiles do
    setup_temp_keychain
    unlock_temp_keychain
    
    match(
      app_identifier: ENV["APP_IDENTIFIER"],
      type: ENV["DISTRIBUTION_TYPE"],
      git_url: ENV["GIT_URL"],
      keychain_name: "app-signing",
      keychain_password:ENV['KEYCHAIN_PASSWORD'],
      readonly: true
    )
  end

  desc <<~DOC
    Create a temporary keychain for CI builds and expose its credentials to the environment.

    Parameters:
      keychain_name       - Name of the keychain to create.
      keychain_password   - Password for the keychain.
      default_keychain    - Whether to set the keychain as the default.
      timeout             -Auto-lock timeout in seconds. Default: 3600 (1 hour).

    Behavior:
      - Creates and unlocks the keychain.
      - Exposes keychain_name and keychain_password for reuse in other lanes (e.g., match/gym).
  DOC
  private_lane :setup_temp_keychain do
    keychain_name = "app-signing"
    keychain_password = ENV["KEYCHAIN_PASSWORD"]

    create_keychain(
      name: keychain_name,
      password: keychain_password,
      default_keychain: true,
      unlock: true,
      timeout: 21600,
      lock_when_sleeps: false,
      add_to_search_list: true
    )
  end

  desc <<~DOC
    Unlock the signing keychain and set it as the default so codesign can access identities.

    Parameters:
      path            - Keychain name or full path. Example: "app-signing" or "app-signing.keychain-db".
      password        - Password used to unlock the keychain.
      set_default     - Whether to make the unlocked keychain the default for this session. Here: true.

    Behavior:
      - Unlocks the keychain at `path` with the provided password.
      - Sets it as the default keychain (because set_default: true), which is often required in CI.

    Environment:
      - KEYCHAIN_PASSWORD must be set to the keychainâ€™s password.
  DOC
  private_lane :unlock_temp_keychain do
    unlock_keychain(
      path: "app-signing",
      password: ENV['KEYCHAIN_PASSWORD'],
      set_default: true
    )
  end

  desc <<~DOC
    Delete the temporary signing keychain created for CI builds.

    Parameters:
      name - The name of the keychain to delete. Default: "app-signing".

    Behavior:
      - Removes the temporary keychain from the system.
      - Should be called after build/signing operations are complete to clean up resources.
      - This is a private lane, intended to be called by other lanes only.
  DOC
  private_lane :delete_temp_keychain do
    delete_keychain(name: "app-signing")
  end
end