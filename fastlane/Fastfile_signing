# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do
  desc <<~DOC
    Download the provisioning profiles stored in the remote repository to be used in github actions
  DOC
  lane :download_profiles do
    match(
      app_identifier: ENV["APP_IDENTIFIER"],
      type: ENV["DISTRIBUTION_TYPE"],
      git_url: ENV["GIT_URL"],
      keychain_name: "app-signing",
      keychain_password:ENV['KEYCHAIN_PASSWORD'],
      readonly: true
    )
  end

  desc "Build app for ad-hoc distribution"
  lane :build_app_adhoc do
    build_app_with_provisioning(distribution_type: "adhoc", export_method: "ad-hoc", configuration: "Release")
  end

  desc <<~DOC
    Create a temporary keychain for CI builds and expose its credentials to the environment.

    Parameters:
      keychain_name       - Name of the keychain to create.
      keychain_password   - Password for the keychain.
      default_keychain    - Whether to set the keychain as the default.
      timeout             -Auto-lock timeout in seconds. Default: 3600 (1 hour).

    Behavior:
      - Creates and unlocks the keychain.
      - Exposes keychain_name and keychain_password for reuse in other lanes (e.g., match/gym).
  DOC
  lane :setup_temp_keychain do
    keychain_name = "app-signing"
    keychain_password = ENV["KEYCHAIN_PASSWORD"]

    create_keychain(
      name: keychain_name,
      password: keychain_password,
      default_keychain: true,
      unlock: true,
      timeout: 21600,
      lock_when_sleeps: false,
      add_to_search_list: true
    )
  end

  desc <<~DOC
    Unlock the signing keychain and set it as the default so codesign can access identities.

    Parameters:
      path            - Keychain name or full path. Example: "app-signing" or "app-signing.keychain-db".
      password        - Password used to unlock the keychain.
      set_default     - Whether to make the unlocked keychain the default for this session. Here: true.

    Behavior:
      - Unlocks the keychain at `path` with the provided password.
      - Sets it as the default keychain (because set_default: true), which is often required in CI.

    Environment:
      - KEYCHAIN_PASSWORD must be set to the keychain’s password.
  DOC
  lane :unlock_temp_keychain do
    unlock_keychain(
      path: "app-signing",
      password: ENV['KEYCHAIN_PASSWORD'],
      set_default: true
    )
  end

  desc "Delete temp signing keychain"
  lane :delete_temp_keychain do
    delete_keychain(name: "app-signing")
  end

  desc <<~DOC
    Complete build process for app distribution.
  
    This lane combines provisioning setup and app building into a single workflow.
    It first sets up the necessary code signing certificates and provisioning profiles,
    then builds and exports the app as an IPA ready for distribution.
  
    Parameters:
      distribution_type - Type of distribution for provisioning: "adhoc" or "development" (default: "adhoc")
      export_method     - Export method for build: "ad-hoc" or "development" (default: "ad-hoc")
      configuration     - The configuration from the Xcode project setup: "Release", "Debug"
  
    Environment Variables:
      APP_IDENTIFIER    - Bundle identifier for the app
      APP_SCHEME        - Xcode scheme to build
      IPA_FILE          - Output name for the generated IPA file (without extension)
      MATCH_GIT_URL     - Git URL for the match certificates repository
  DOC
  lane :build_app_with_provisioning do |options|
    distribution_type = options[:distribution_type]
    export_method = options[:export_method]
    configuration = options[:configuration]
  
    setup_temp_keychain
    unlock_temp_keychain
    download_profiles
    build_app_match(export_method: export_method, configuration: configuration)
  ensure
    # Always clean up
    delete_temp_keychain
  end

  desc <<~DOC
    Build and export app as an IPA.
  
    This lane compiles the specified app scheme, archives it, and exports it as an IPA file 
    ready for distribution. The build includes cleaning and detailed logging for debugging.
  
    Parameters:
      export_method - Export method: "ad-hoc" or "development" (default: "ad-hoc")
      configuration - The configuration from the Xcode project setup: "Release", "Debug"
  
    Environment Variables:
      APP_SCHEME    - Xcode scheme to build
      IPA_FILE      - Output name for the generated IPA file (without extension)
  DOC
  lane :build_app_match do |options|
    scheme = ENV["APP_SCHEME"]
    ipaFile = ENV["IPA_FILE"]
    export_method = options[:export_method]
    configuration = options[:configuration]

    # Skip confirmation for development builds in CI
    if export_method == "development"
      ENV["FASTLANE_SKIP_WAITING_FOR_BUILD_PROCESSING"] = "true"
      puts "⚠️  Skipping waiting for build processing (development build)"
    end
    gym(
      scheme: scheme,
      export_method: export_method,
      configuration: configuration,
      silent: false,
      clean: true,
      export_options: { 
        manageAppVersionAndBuildNumber: false 
      },
      export_team_id: "JA825X8F7Z",
      codesigning_identity: ENV["CODESIGNING_IDENTITY"],
      output_name: ipaFile
    )
  end
end